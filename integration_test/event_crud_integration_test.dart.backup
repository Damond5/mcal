import 'package:flutter/material.dart';
import 'package:flutter_test/flutter_test.dart';
import 'package:integration_test/integration_test.dart';
import 'package:mcal/main.dart';
import 'package:mcal/providers/event_provider.dart';
import 'package:mcal/providers/theme_provider.dart';
import 'package:mcal/frb_generated.dart';
import 'package:mcal/calendar_widget.dart';
import 'package:mcal/widgets/event_list.dart';
import 'package:provider/provider.dart';
import '../test/test_helpers.dart';
import 'helpers/test_fixtures.dart';

void main() {
  IntegrationTestWidgetsFlutterBinding.ensureInitialized();

  setUpAll(() async {
    await RustLib.init();
    await setupAllIntegrationMocks();
  });

  setUp(() async {
    await cleanTestEvents();
  });

  tearDownAll(() async {
    await cleanupTestEnvironment();
  });

  group('Phase 13: Multi-Event Scenarios Integration Tests', () {
    group('Task 13.1: Multiple events same day tests', () {
      testWidgets('Calendar shows marker for day with multiple events', (
        tester,
      ) async {
        late EventProvider eventProvider;

        await tester.pumpWidget(
          MultiProvider(
            providers: [
              ChangeNotifierProvider(create: (_) => ThemeProvider()),
              ChangeNotifierProvider(create: (_) => EventProvider()),
            ],
            child: Builder(
              builder: (context) {
                eventProvider = Provider.of<EventProvider>(
                  context,
                  listen: false,
                );
                return const MyApp();
              },
            ),
          ),
        );

        await tester.pumpAndSettle();
        await tester.pumpAndSettle();

        await tester.tap(find.text('15'));
        await tester.pumpAndSettle();

        final events = TestFixtures.createEventsForSameDay(count: 3);
        for (final event in events) {
          await tester.tap(find.text('15'));
          await tester.pumpAndSettle();

          await tester.tap(find.byType(FloatingActionButton));
          await tester.pumpAndSettle();

          await tester.enterText(
            find.byKey(const Key('event_title_field')),
            event.title,
          );
          await tester.pumpAndSettle();

          await tester.tap(find.text('Save'));
          await tester.pumpAndSettle();
        }

        await tester.pumpAndSettle();
        expect(eventProvider.eventsCount, greaterThanOrEqualTo(3));
      });

      testWidgets('Event list shows all events for day', (tester) async {
        await tester.pumpWidget(
          MultiProvider(
            providers: [
              ChangeNotifierProvider(create: (_) => ThemeProvider()),
              ChangeNotifierProvider(create: (_) => EventProvider()),
            ],
            child: const MyApp(),
          ),
        );

        await tester.pumpAndSettle();
        await tester.pumpAndSettle();

        await tester.tap(find.text('15'));
        await tester.pumpAndSettle();

        final events = TestFixtures.createEventsForSameDay(count: 3);
        for (final event in events) {
          await tester.tap(find.text('15'));
          await tester.pumpAndSettle();

          await tester.tap(find.byType(FloatingActionButton));
          await tester.pumpAndSettle();

          await tester.enterText(
            find.byKey(const Key('event_title_field')),
            event.title,
          );
          await tester.pumpAndSettle();

          await tester.tap(find.text('Save'));
          await tester.pumpAndSettle();
        }

        await tester.pumpAndSettle();
        await tester.tap(find.text('15'));
        await tester.pumpAndSettle();

        expect(find.byType(Card), findsNWidgets(3));
      });

      testWidgets('Events are in correct order', (tester) async {
        await tester.pumpWidget(
          MultiProvider(
            providers: [
              ChangeNotifierProvider(create: (_) => ThemeProvider()),
              ChangeNotifierProvider(create: (_) => EventProvider()),
            ],
            child: const MyApp(),
          ),
        );

        await tester.pumpAndSettle();

        // Select a day first before adding events
        await tester.tap(find.text('15'));
        await tester.pumpAndSettle();

        final events = TestFixtures.createEventsForSameDay(count: 3);
        for (final event in events) {
          await tester.tap(find.byType(FloatingActionButton));
          await tester.pumpAndSettle();

          await tester.enterText(
            find.byKey(const Key('event_title_field')),
            event.title,
          );
          await tester.pumpAndSettle();

          await tester.tap(find.text('Save'));
          await tester.pumpAndSettle();
        }

        await tester.pumpAndSettle();
        await tester.tap(find.text('15'));
        await tester.pumpAndSettle();

        expect(find.byType(Card), findsNWidgets(5));
      });

       testWidgets('Each event can be edited independently', (tester) async {
         await tester.pumpWidget(
           MultiProvider(
             providers: [
               ChangeNotifierProvider(create: (_) => ThemeProvider()),
               ChangeNotifierProvider(create: (_) => EventProvider()),
             ],
             child: const MyApp(),
           ),
         );

         await tester.pumpAndSettle();
         await tester.pumpAndSettle();

         await tester.tap(find.text('15'));
         await tester.pumpAndSettle();

         final events = TestFixtures.createEventsForSameDay(count: 2);
         for (final event in events) {
           await tester.tap(find.text('15'));
           await tester.pumpAndSettle();

           await tester.tap(find.byType(FloatingActionButton));
           await tester.pumpAndSettle();

           await tester.enterText(
             find.byKey(const Key('event_title_field')),
             event.title,
           );
           await tester.pumpAndSettle();

           await tester.tap(find.text('Save'));
           await tester.pumpAndSettle();
         }

         await tester.pumpAndSettle();
         await tester.tap(find.text('15'));
         await tester.pumpAndSettle();

         await tester.tap(find.text('Event 0'));
         await tester.pumpAndSettle();

         await tester.tap(find.text('Edit'));
         await tester.pumpAndSettle();

         expect(find.text('Edit Event'), findsOneWidget);
       });

       testWidgets('Each event can be deleted independently', (tester) async {
         await tester.pumpWidget(
           MultiProvider(
             providers: [
               ChangeNotifierProvider(create: (_) => ThemeProvider()),
               ChangeNotifierProvider(create: (_) => EventProvider()),
             ],
             child: const MyApp(),
           ),
         );

         await tester.pumpAndSettle();
         await tester.pumpAndSettle();

         await tester.tap(find.text('15'));
         await tester.pumpAndSettle();

         final events = TestFixtures.createEventsForSameDay(count: 2);
         for (final event in events) {
           await tester.tap(find.text('15'));
           await tester.pumpAndSettle();

           await tester.tap(find.byType(FloatingActionButton));
           await tester.pumpAndSettle();

           await tester.enterText(
             find.byKey(const Key('event_title_field')),
             event.title,
           );
           await tester.pumpAndSettle();

           await tester.tap(find.text('Save'));
           await tester.pumpAndSettle();
         }

         await tester.pumpAndSettle();
         await tester.tap(find.text('15'));
         await tester.pumpAndSettle();

         await tester.tap(find.byIcon(Icons.delete).first);
         await tester.pumpAndSettle();

          await tester.tap(find.text('Delete'));
          await tester.pumpAndSettle();

          expect(find.byType(Card), findsOneWidget);
        });
    });
  });

    group('Task 13.2: Overlapping events tests', () {
      testWidgets('Events with same time display correctly', (tester) async {
        await tester.pumpWidget(
          MultiProvider(
            providers: [
              ChangeNotifierProvider(create: (_) => ThemeProvider()),
              ChangeNotifierProvider(create: (_) => EventProvider()),
            ],
            child: const MyApp(),
          ),
        );

        await tester.pumpAndSettle();
        await tester.pumpAndSettle();

      await tester.tap(find.text('15'));
      await tester.pumpAndSettle();

      final events = TestFixtures.createOverlappingEvents();
      for (final event in events) {
        await tester.tap(find.text('15'));
        await tester.pumpAndSettle();

        await tester.tap(find.byType(FloatingActionButton));
        await tester.pumpAndSettle();

        await tester.enterText(
          find.byKey(const Key('event_title_field')),
          event.title,
        );
        await tester.pumpAndSettle();

        await tester.tap(find.text('Save'));
        await tester.pumpAndSettle();
      }

      await tester.pumpAndSettle();
      await tester.tap(find.text('15'));
      await tester.pumpAndSettle();

       expect(find.byType(Card), findsNWidgets(3));
    });
  });

    group('Task 13.2: Overlapping events tests', () {
      testWidgets('Events with same time display correctly', (tester) async {
        await tester.pumpWidget(
          MultiProvider(
            providers: [
              ChangeNotifierProvider(create: (_) => ThemeProvider()),
              ChangeNotifierProvider(create: (_) => EventProvider()),
            ],
            child: const MyApp(),
          ),
        );

      await tester.pumpAndSettle();
      await tester.pumpAndSettle();

      await tester.tap(find.text('15'));
      await tester.pumpAndSettle();

      final events = TestFixtures.createOverlappingEvents();
      for (final event in events) {
        await tester.tap(find.text('15'));
        await tester.pumpAndSettle();

        await tester.tap(find.byType(FloatingActionButton));
        await tester.pumpAndSettle();

        await tester.enterText(
          find.byKey(const Key('event_title_field')),
          event.title,
        );
        await tester.pumpAndSettle();

        await tester.tap(find.text('Save'));
        await tester.pumpAndSettle();
      }

      await tester.pumpAndSettle();
      await tester.tap(find.text('15'));
      await tester.pumpAndSettle();

      expect(find.byType(Card), findsNWidgets(3));
      expect(find.text('Overlapping Event 1'), findsOneWidget);
      expect(find.text('Overlapping Event 2'), findsOneWidget);
      expect(find.text('Overlapping Event 3'), findsOneWidget);
    });

    testWidgets('Each overlapping event can be edited', (tester) async {
        await tester.pumpWidget(
          MultiProvider(
            providers: [
              ChangeNotifierProvider(create: (_) => ThemeProvider()),
              ChangeNotifierProvider(create: (_) => EventProvider()),
            ],
            child: const MyApp(),
          ),
        );

        await tester.pumpAndSettle();

        final events = TestFixtures.createOverlappingEvents();
        for (final event in events) {
          await tester.tap(find.byType(FloatingActionButton));
          await tester.pumpAndSettle();

          await tester.enterText(
            find.byKey(const Key('event_title_field')),
            event.title,
          );
          await tester.pumpAndSettle();

          await tester.tap(find.text('Save'));
          await tester.pumpAndSettle();
        }

        await tester.pumpAndSettle();
        await tester.tap(find.text('15'));
        await tester.pumpAndSettle();

        await tester.tap(find.text('Overlapping Event 2'));
        await tester.pumpAndSettle();

        await tester.tap(find.text('Edit'));
        await tester.pumpAndSettle();

        expect(find.text('Edit Event'), findsOneWidget);
      });

      testWidgets('Each overlapping event can be deleted', (tester) async {
        await tester.pumpWidget(
          MultiProvider(
            providers: [
              ChangeNotifierProvider(create: (_) => ThemeProvider()),
              ChangeNotifierProvider(create: (_) => EventProvider()),
            ],
            child: const MyApp(),
          ),
        );

        await tester.pumpAndSettle();

        final events = TestFixtures.createOverlappingEvents();
        for (final event in events) {
          await tester.tap(find.byType(FloatingActionButton));
          await tester.pumpAndSettle();

          await tester.enterText(
            find.byKey(const Key('event_title_field')),
            event.title,
          );
          await tester.pumpAndSettle();

          await tester.tap(find.text('Save'));
          await tester.pumpAndSettle();
        }

        await tester.pumpAndSettle();
        await tester.tap(find.text('15'));
        await tester.pumpAndSettle();

        await tester.tap(find.byIcon(Icons.delete).first);
        await tester.pumpAndSettle();

        await tester.tap(find.text('Delete'));
        await tester.pumpAndSettle();

        expect(find.byType(Card), findsNWidgets(2));
      });
    });

    group('Task 13.3a: Many recurring events creation tests', () {
      testWidgets('Yearly recurring events over many years', (tester) async {
        late EventProvider eventProvider;

        await tester.pumpWidget(
          MultiProvider(
            providers: [
              ChangeNotifierProvider(create: (_) => ThemeProvider()),
              ChangeNotifierProvider(create: (_) => EventProvider()),
            ],
            child: Builder(
              builder: (context) {
                eventProvider = Provider.of<EventProvider>(
                  context,
                  listen: false,
                );
                return const MyApp();
              },
            ),
          ),
        );

        await tester.pumpAndSettle();

        await tester.tap(find.text('15'));

        await tester.pumpAndSettle();

        await tester.tap(find.byType(FloatingActionButton));
        await tester.pumpAndSettle();

        final event = TestFixtures.createBirthdayEvent();
        final titleField = find.ancestor(
          of: find.text('Title'),
          matching: find.byType(TextField),
        );
        await tester.enterText(titleField, event.title);
        await tester.pumpAndSettle();

        await tester.tap(find.text('none'));
        await tester.pumpAndSettle();

        await tester.tap(find.text('yearly'));
        await tester.pumpAndSettle();

        await tester.tap(find.text('Save'));
        await tester.pumpAndSettle();

        await tester.pumpAndSettle();
        expect(eventProvider.eventsCount, greaterThanOrEqualTo(1));
      });

      testWidgets('Calendar handles many recurring events', (tester) async {
        await tester.pumpWidget(
          MultiProvider(
            providers: [
              ChangeNotifierProvider(create: (_) => ThemeProvider()),
              ChangeNotifierProvider(create: (_) => EventProvider()),
            ],
            child: const MyApp(),
          ),
        );

        await tester.pumpAndSettle();

        await tester.tap(find.text('15'));

        await tester.pumpAndSettle();

        await tester.tap(find.byType(FloatingActionButton));
        await tester.pumpAndSettle();

        final event = TestFixtures.createDailyStandup();
        final titleField = find.ancestor(
          of: find.text('Title'),
          matching: find.byType(TextField),
        );
        await tester.enterText(titleField, event.title);
        await tester.pumpAndSettle();

        await tester.tap(find.text('none'));
        await tester.pumpAndSettle();

        await tester.tap(find.text('daily'));
        await tester.pumpAndSettle();

        await tester.tap(find.text('Save'));
        await tester.pumpAndSettle();

        await tester.pumpAndSettle();
        expect(find.byType(CalendarWidget), findsOneWidget);
      });

      testWidgets('Event list handles many recurring instances', (
        tester,
      ) async {
        await tester.pumpWidget(
          MultiProvider(
            providers: [
              ChangeNotifierProvider(create: (_) => ThemeProvider()),
              ChangeNotifierProvider(create: (_) => EventProvider()),
            ],
            child: const MyApp(),
          ),
        );

        await tester.pumpAndSettle();

        await tester.tap(find.text('15'));

        await tester.pumpAndSettle();

        await tester.tap(find.byType(FloatingActionButton));
        await tester.pumpAndSettle();

        final event = TestFixtures.createWeeklyMeeting();
        final titleField = find.ancestor(
          of: find.text('Title'),
          matching: find.byType(TextField),
        );
        await tester.enterText(titleField, event.title);
        await tester.pumpAndSettle();

        await tester.tap(find.text('none'));
        await tester.pumpAndSettle();

        await tester.tap(find.text('weekly'));
        await tester.pumpAndSettle();

        await tester.tap(find.text('Save'));
        await tester.pumpAndSettle();

        await tester.pumpAndSettle();
        await tester.tap(find.text('15'));
        await tester.pumpAndSettle();

        expect(find.byType(EventList), findsOneWidget);
      });
    });

    group('Task 13.3b: Many recurring events performance tests', () {
      testWidgets('Yearly events over 50 years load in reasonable time', (
        tester,
      ) async {
        final stopwatch = Stopwatch()..start();

        await tester.pumpWidget(
          MultiProvider(
            providers: [
              ChangeNotifierProvider(create: (_) => ThemeProvider()),
              ChangeNotifierProvider(create: (_) => EventProvider()),
            ],
            child: const MyApp(),
          ),
        );

        await tester.pumpAndSettle();

        await tester.tap(find.text('15'));

        await tester.pumpAndSettle();

        await tester.tap(find.byType(FloatingActionButton));
        await tester.pumpAndSettle();

        final event = TestFixtures.createBirthdayEvent();
        final titleField = find.ancestor(
          of: find.text('Title'),
          matching: find.byType(TextField),
        );
        await tester.enterText(titleField, event.title);
        await tester.pumpAndSettle();

        await tester.tap(find.text('none'));
        await tester.pumpAndSettle();

        await tester.tap(find.text('yearly'));
        await tester.pumpAndSettle();

        await tester.tap(find.text('Save'));
        await tester.pumpAndSettle();

        await tester.pumpAndSettle();
        stopwatch.stop();

        expect(stopwatch.elapsedMilliseconds, lessThan(10000));
      });

      testWidgets('Calendar displays many yearly event instances', (
        tester,
      ) async {
        await tester.pumpWidget(
          MultiProvider(
            providers: [
              ChangeNotifierProvider(create: (_) => ThemeProvider()),
              ChangeNotifierProvider(create: (_) => EventProvider()),
            ],
            child: const MyApp(),
          ),
        );

        await tester.pumpAndSettle();

        await tester.tap(find.text('15'));

        await tester.pumpAndSettle();

        await tester.tap(find.byType(FloatingActionButton));
        await tester.pumpAndSettle();

        final event = TestFixtures.createBirthdayEvent();
        final titleField = find.ancestor(
          of: find.text('Title'),
          matching: find.byType(TextField),
        );
        await tester.enterText(titleField, event.title);
        await tester.pumpAndSettle();

        await tester.tap(find.text('none'));
        await tester.pumpAndSettle();

        await tester.tap(find.text('yearly'));
        await tester.pumpAndSettle();

        await tester.tap(find.text('Save'));
        await tester.pumpAndSettle();

        await tester.pumpAndSettle();
        expect(find.byType(CalendarWidget), findsOneWidget);
      });

      testWidgets('Performance does not degrade with long chains', (
        tester,
      ) async {
        final stopwatch = Stopwatch()..start();

        await tester.pumpWidget(
          MultiProvider(
            providers: [
              ChangeNotifierProvider(create: (_) => ThemeProvider()),
              ChangeNotifierProvider(create: (_) => EventProvider()),
            ],
            child: const MyApp(),
          ),
        );

        await tester.pumpAndSettle();

        await tester.tap(find.text('15'));

        await tester.pumpAndSettle();

        await tester.tap(find.byType(FloatingActionButton));
        await tester.pumpAndSettle();

        final event = TestFixtures.createMonthlyReview();
        final titleField = find.ancestor(
          of: find.text('Title'),
          matching: find.byType(TextField),
        );
        await tester.enterText(titleField, event.title);
        await tester.pumpAndSettle();

        await tester.tap(find.text('none'));
        await tester.pumpAndSettle();

        await tester.tap(find.text('monthly'));
        await tester.pumpAndSettle();

        await tester.tap(find.text('Save'));
        await tester.pumpAndSettle();

        await tester.pumpAndSettle();
        stopwatch.stop();

        expect(stopwatch.elapsedMilliseconds, lessThan(10000));
      });

      testWidgets('Each test file runs in under 60 seconds', (tester) async {
        final stopwatch = Stopwatch()..start();

        await tester.pumpWidget(
          MultiProvider(
            providers: [
              ChangeNotifierProvider(create: (_) => ThemeProvider()),
              ChangeNotifierProvider(create: (_) => EventProvider()),
            ],
            child: const MyApp(),
          ),
        );

        await tester.pumpAndSettle();

        await tester.tap(find.text('15'));

        await tester.pumpAndSettle();

        await tester.tap(find.byType(FloatingActionButton));
        await tester.pumpAndSettle();

        final event = TestFixtures.createSampleEvent();
        final titleField = find.ancestor(
          of: find.text('Title'),
          matching: find.byType(TextField),
        );
        await tester.enterText(titleField, event.title);
        await tester.pumpAndSettle();

        await tester.tap(find.text('Save'));
        await tester.pumpAndSettle();

        await tester.pumpAndSettle();
        stopwatch.stop();

        expect(stopwatch.elapsed.inSeconds, lessThan(60));
      });
    });
  });
}
